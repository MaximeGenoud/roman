<!doctype html>
<html lang="fr">

<head>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700;900&family=Inter:wght@400;600;800&display=swap"
    rel="stylesheet">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Domus Sonora — Panel Musical (Imperium)</title>

  <style>
    :root{
      --bg0:#050608;
      --bg1:#07090c;

      --stone:#0f1218;
      --stone2:#141824;

      --text:#f4edd9;
      --muted:#c9bb97;

      --gold:#d6b15a;     /* or patiné */
      --gold2:#a77c2c;    /* bronze */
      --gold3:#7a5a1d;    /* patine */

      --line: rgba(214,177,90,.22);
      --line2: rgba(244,237,217,.08);

      --shadow: 0 18px 70px rgba(0,0,0,.55);
      --radius: 18px;
    }

    * { box-sizing: border-box; }

    body{
      margin:0;
      min-height:100svh;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);

      background:
        radial-gradient(900px 520px at 15% 10%, rgba(214,177,90,.16), transparent 58%),
        radial-gradient(800px 420px at 85% 12%, rgba(167,124,44,.14), transparent 56%),
        radial-gradient(900px 720px at 50% 105%, rgba(255,255,255,.05), transparent 60%),
        linear-gradient(180deg, var(--bg0) 0%, var(--bg1) 55%, var(--bg0) 100%);

      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }

    /* grain discret */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      opacity:.14;
      background-image:
        repeating-linear-gradient(0deg, rgba(255,255,255,.04) 0 1px, transparent 1px 3px),
        repeating-linear-gradient(90deg, rgba(0,0,0,.10) 0 1px, transparent 1px 4px);
      mix-blend-mode: overlay;
    }

    .wrap{
      width:min(1100px, 100%);
      display:grid;
      gap:16px;
      grid-template-columns: 1.3fr .9fr;
    }
    @media (max-width: 920px){
      .wrap{ grid-template-columns: 1fr; }
    }

    /* carte pierre taillée */
    .card{
      position:relative;
      border-radius: var(--radius);
      background:
        linear-gradient(180deg, rgba(20,24,36,.82) 0%, rgba(12,14,20,.86) 100%);
      border: 1px solid var(--line2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-2px;
      pointer-events:none;
      background:
        radial-gradient(700px 230px at 20% 0%, rgba(214,177,90,.18), transparent 65%),
        radial-gradient(520px 210px at 85% 5%, rgba(214,177,90,.10), transparent 65%);
      opacity:.85;
    }
    /* double cadre gravé */
    .card::after{
      content:"";
      position:absolute;
      inset:10px;
      border-radius: calc(var(--radius) - 10px);
      pointer-events:none;
      border: 1px solid rgba(214,177,90,.18);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.06),
        inset 0 -1px 0 rgba(0,0,0,.55);
    }

    header{
      padding:18px 18px 14px 18px;
      position:relative;
      z-index:1;
      border-bottom:1px solid rgba(214,177,90,.18);
      background: linear-gradient(180deg, rgba(0,0,0,.26), transparent);
    }
    /* petite frise dorée */
    header::after{
      content:"";
      display:block;
      margin-top:12px;
      height:6px;
      opacity:.6;
      background:
        linear-gradient(90deg,
          transparent 0%,
          rgba(214,177,90,.18) 10%,
          rgba(214,177,90,.30) 50%,
          rgba(214,177,90,.18) 90%,
          transparent 100%);
    }

    .title{
      display:flex;
      align-items:center;
      gap:12px;
    }

    .sigil{
      width:44px;
      height:44px;
      border-radius: 14px;
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.18), transparent 55%),
        linear-gradient(145deg, rgba(214,177,90,.25), rgba(167,124,44,.15));
      border:1px solid rgba(214,177,90,.22);
      display:grid;
      place-items:center;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .sigil svg{
      width:26px;
      height:26px;
      fill: var(--gold);
      opacity:.92;
    }

    /* titres romains */
    h1{
      margin:0;
      font-size: 18px;
      font-family: Cinzel, serif;
      letter-spacing: .08em;
      text-transform: uppercase;
    }
    .sub{
      margin: 2px 0 0 0;
      color: var(--muted);
      font-size: 12.5px;
    }

    .content{
      padding:16px 18px 18px 18px;
      position:relative;
      z-index:1;
    }

    .now{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }
    .trackname{
      font-weight: 800;
      font-size: 16px;
      line-height: 1.25;
      margin: 0;
    }
    .meta{
      margin-top: 4px;
      color: var(--muted);
      font-size: 12.5px;
    }

    .badge{
      border:1px solid rgba(214,177,90,.22);
      color: var(--gold);
      background: rgba(214,177,90,.06);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      letter-spacing:.12em;
      font-family: Cinzel, serif;
      white-space: nowrap;
    }

    .controls{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin:10px 0 12px 0;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    button{
      appearance:none;
      border:none;
      cursor:pointer;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 800;
      color: var(--text);
      background: rgba(214,177,90,.08);
      border: 1px solid rgba(214,177,90,.22);
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    button:hover{
      background: rgba(214,177,90,.12);
      border-color: rgba(214,177,90,.30);
    }
    button:active{
      transform: translateY(1px) scale(.99);
    }
    button.primary{
      background: linear-gradient(145deg, rgba(214,177,90,.28), rgba(167,124,44,.18));
      border-color: rgba(214,177,90,.34);
    }
    button.danger{
      background: rgba(255,80,80,.10);
      border-color: rgba(255,80,80,.20);
    }
    button.wide{
      flex:1;
      min-width: 140px;
    }
    button.toggle.on{
      background: rgba(214,177,90,.14);
      border-color: rgba(214,177,90,.34);
    }

    .bar{
      width:100%;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(214,177,90,.14);
      border-radius: 999px;
      height: 10px;
      overflow:hidden;
      position:relative;
      cursor:pointer;
    }
    .bar>i{
      display:block;
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(214,177,90,.60), rgba(214,177,90,.22));
    }
    .time{
      display:flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
    }

    .sliders{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 10px;
    }
    @media (max-width: 520px){
      .sliders{ grid-template-columns: 1fr; }
    }
    .slider{
      border:1px solid rgba(214,177,90,.14);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding: 12px 12px 10px 12px;
    }
    .slider label{
      display:flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
    }
    input[type="range"]{ width:100%; }

    .list{
      padding: 12px 12px 14px 12px;
      max-height: 520px;
      overflow:auto;
      position:relative;
      z-index:1;
    }
    .item{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap:10px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(214,177,90,.10);
      background: rgba(255,255,255,.02);
      margin: 8px 0;
      cursor:pointer;
      transition: background .15s ease, border-color .15s ease;
    }
    .item:hover{
      background: rgba(214,177,90,.06);
      border-color: rgba(214,177,90,.18);
    }
    .item.active{
      background: rgba(214,177,90,.10);
      border-color: rgba(214,177,90,.28);
    }
    .item .left{
      display:flex;
      flex-direction: column;
      gap:2px;
      min-width:0;
    }
    .item .t{
      font-weight: 900;
      font-size: 13.5px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 520px;
    }
    .item .s{
      color: var(--muted);
      font-size: 12px;
    }
    .pill{
      color: var(--gold);
      border: 1px solid rgba(214,177,90,.20);
      background: rgba(214,177,90,.06);
      border-radius: 999px;
      padding: 5px 9px;
      font-size: 12px;
      white-space: nowrap;
    }

    .footerNote{
      padding: 12px 18px 16px 18px;
      border-top: 1px solid rgba(214,177,90,.14);
      color: var(--muted);
      font-size: 12.5px;
      position:relative;
      z-index:1;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <section class="card">
      <header>
        <div class="title">
          <div class="sigil" aria-hidden="true">
            <svg viewBox="0 0 24 24">
              <path
                d="M11.2 4.2c-3 1.2-5 3.6-5.7 6.9-.5 2.5.1 5.1 1.8 7.8.3.5 1 .6 1.5.2.4-.3.5-.8.2-1.3-1.4-2.2-1.9-4.3-1.5-6.3.5-2.5 2-4.3 4.4-5.3.5-.2.8-.8.6-1.3-.2-.5-.8-.8-1.3-.7zm1.6 0c-.5-.2-1.1.1-1.3.6-.2.5.1 1.1.6 1.3 2.4 1 3.9 2.8 4.4 5.3.4 2-.1 4.1-1.5 6.3-.3.5-.2 1 .2 1.3.5.4 1.2.3 1.5-.2 1.7-2.7 2.3-5.3 1.8-7.8-.7-3.3-2.7-5.7-5.7-6.9z" />
              <path
                d="M12 19.8c-3.1 0-5.7-1.3-7.6-3.9-.3-.4-.2-1 .2-1.3.4-.3 1-.2 1.3.2 1.6 2.1 3.7 3.1 6.1 3.1s4.5-1 6.1-3.1c.3-.4.9-.5 1.3-.2.4.3.5.9.2 1.3-1.9 2.6-4.5 3.9-7.6 3.9z" />
            </svg>
          </div>
          <div>
            <h1>Domus Sonora — Panel musical</h1>
            <div class="sub">Imperium Mode • EQ • Loop A/B • Mobile</div>
          </div>
        </div>
      </header>

      <div class="content">
        <div class="now">
          <div>
            <p class="trackname" id="nowTitle">—</p>
            <div class="meta" id="nowMeta">Prêt.</div>
          </div>
          <div class="badge" id="stateBadge">IDLE</div>
        </div>

        <div class="controls">
          <div class="row">
            <button id="prevBtn" class="wide">⟵ Précédent</button>
            <button id="playBtn" class="primary wide">▶︎ Lecture</button>
            <button id="nextBtn" class="wide">Suivant ⟶</button>
            <button id="stopBtn" class="danger">⏹ Stop</button>
          </div>

          <div class="row">
            <button id="loopBtn" class="toggle">⟲ Loop</button>
            <button id="aBtn" class="toggle">A</button>
            <button id="bBtn" class="toggle">B</button>
            <button id="abBtn" class="toggle">A↔B</button>
            <button id="clearLoopBtn" class="danger">✖ Loops</button>
          </div>

          <div>
            <div class="bar" id="seekBar" title="Cliquer pour avancer/reculer">
              <i id="seekFill"></i>
            </div>
            <div class="time">
              <span id="tCur">0:00</span>
              <span id="tDur">0:00</span>
            </div>
          </div>

          <div class="sliders">
            <div class="slider">
              <label><span>Volume</span> <span id="volVal">80%</span></label>
              <input id="vol" type="range" min="0" max="100" value="80" />
            </div>
            <div class="slider">
              <label><span>Basses</span> <span id="bassVal">+0 dB</span></label>
              <input id="bass" type="range" min="-12" max="12" step="1" value="0" />
            </div>
            <div class="slider">
              <label><span>Médiums</span> <span id="midVal">+0 dB</span></label>
              <input id="mid" type="range" min="-12" max="12" step="1" value="0" />
            </div>
            <div class="slider">
              <label><span>Aigus</span> <span id="trebleVal">+0 dB</span></label>
              <input id="treble" type="range" min="-12" max="12" step="1" value="0" />
            </div>
            <div class="slider">
              <label><span>Balance (L/R)</span> <span id="panVal">0</span></label>
              <input id="pan" type="range" min="-100" max="100" step="1" value="0" />
            </div>
            <div class="slider">
              <label><span>Vitesse</span> <span id="rateVal">1.00×</span></label>
              <input id="rate" type="range" min="0.5" max="1.5" step="0.01" value="1.00" />
            </div>
            <div class="slider">
              <label><span>Fade in</span> <span id="fadeInVal">0.0s</span></label>
              <input id="fadeIn" type="range" min="0" max="5" step="0.1" value="0" />
            </div>
            <div class="slider">
              <label><span>Fade out</span> <span id="fadeOutVal">0.0s</span></label>
              <input id="fadeOut" type="range" min="0" max="8" step="0.1" value="0" />
            </div>
          </div>

          <div class="row">
            <button id="compBtn" class="toggle">⚔ Compresseur</button>
          </div>
        </div>
      </div>

      <div class="footerNote"></div>
    </section>

    <aside class="card">
      <header>
        <div class="title">
          <div class="sigil" aria-hidden="true">
            <svg viewBox="0 0 24 24">
              <path d="M6 5h12a1 1 0 0 1 1 1v1H5V6a1 1 0 0 1 1-1zm-1 5h14v2H5v-2zm0 5h14v2H5v-2zm0 5h14v2H5v-2z" />
            </svg>
          </div>
          <div>
            <h1>Playlist</h1>
            <div class="sub">Clique une piste pour la charger</div>
          </div>
        </div>
      </header>
      <div class="list" id="list"></div>
    </aside>
  </div>

  <script>
    (() => {
      const MP3_FOLDER = "mp3/";
      const TRACKS = [
        { file: "01-intro.mp3", title: "Eternal Shadows", subtitle: "Ouverture solennelle" },
        { file: "02-marche.mp3", title: "Gladiator • Now We Are Free", subtitle: "Pas lourd, tambours" },
        { file: "03-lament.mp3", title: "Gloria Imperii", subtitle: "Triste / noble" },
        { file: "04-honor.mp3", title: "HONOR HIM - Gladiator Soundtrack", subtitle: "Tension et grandeur" },
        { file: "05-porte.mp3", title: "Ryse Son Of Rome", subtitle: "Arrivée rituelle" },
        { file: "06-feu.mp3", title: "Lindsey Stirling - Assassins Creed III", subtitle: "Torches et serment" },
        { file: "07-mer.mp3", title: "Mare Nostrum", subtitle: "Respiration" },
        { file: "08-epilogue.mp3", title: "The Light of Rome", subtitle: "Retombée" },
        { file: "09-finale.mp3", title: "Whispers of Marble", subtitle: "Final impérial" },
      ];

      let idx = 0;
      let isPlaying = false;

      // AB loop
      let A = null, B = null;
      let abEnabled = false;

      // Audio element
      const audio = new Audio();
      audio.preload = "metadata";
      audio.crossOrigin = "anonymous";

      // WebAudio nodes
      let ctx, srcNode, gainNode, panNode, bassNode, midNode, trebleNode, compNode;
      let audioUnlocked = false;
      let compressorOn = false;

      // UI
      const listEl = document.getElementById("list");
      const nowTitle = document.getElementById("nowTitle");
      const nowMeta = document.getElementById("nowMeta");
      const badge = document.getElementById("stateBadge");
      const playBtn = document.getElementById("playBtn");
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");
      const stopBtn = document.getElementById("stopBtn");

      const loopBtn = document.getElementById("loopBtn");
      const aBtn = document.getElementById("aBtn");
      const bBtn = document.getElementById("bBtn");
      const abBtn = document.getElementById("abBtn");
      const clearLoopBtn = document.getElementById("clearLoopBtn");
      const compBtn = document.getElementById("compBtn");

      const seekBar = document.getElementById("seekBar");
      const seekFill = document.getElementById("seekFill");
      const tCur = document.getElementById("tCur");
      const tDur = document.getElementById("tDur");

      const vol = document.getElementById("vol");
      const volVal = document.getElementById("volVal");
      const bass = document.getElementById("bass");
      const bassVal = document.getElementById("bassVal");
      const mid = document.getElementById("mid");
      const midVal = document.getElementById("midVal");
      const treble = document.getElementById("treble");
      const trebleVal = document.getElementById("trebleVal");
      const pan = document.getElementById("pan");
      const panVal = document.getElementById("panVal");
      const rate = document.getElementById("rate");
      const rateVal = document.getElementById("rateVal");
      const fadeIn = document.getElementById("fadeIn");
      const fadeInVal = document.getElementById("fadeInVal");
      const fadeOut = document.getElementById("fadeOut");
      const fadeOutVal = document.getElementById("fadeOutVal");

      const fmt = (s) => {
        if (!Number.isFinite(s) || s <= 0) return "0:00";
        const m = Math.floor(s / 60);
        const r = Math.floor(s % 60);
        return `${m}:${String(r).padStart(2, "0")}`;
      };

      function setBadge() {
        badge.textContent = isPlaying ? "PLAYING" : "PAUSED";
      }

      function setNow() {
        const t = TRACKS[idx];
        nowTitle.textContent = t.title;
        nowMeta.textContent = (t.subtitle ? t.subtitle + " • " : "") + t.file;
      }

      function renderList() {
        listEl.innerHTML = "";
        TRACKS.forEach((t, i) => {
          const div = document.createElement("div");
          div.className = "item" + (i === idx ? " active" : "");
          div.innerHTML = `
            <div class="left">
              <div class="t">${t.title}</div>
              <div class="s">${t.subtitle ?? ""}</div>
            </div>
            <div class="pill">${String(i + 1).padStart(2, "0")}</div>
          `;
          div.addEventListener("click", async () => {
            idx = i;
            await loadTrack(idx, true);
          });
          listEl.appendChild(div);
        });
      }

      async function unlockAudio() {
        if (audioUnlocked) return;
        ctx = new (window.AudioContext || window.webkitAudioContext)();
        srcNode = ctx.createMediaElementSource(audio);

        bassNode = ctx.createBiquadFilter();
        bassNode.type = "lowshelf";
        bassNode.frequency.value = 140;
        bassNode.gain.value = Number(bass.value);

        midNode = ctx.createBiquadFilter();
        midNode.type = "peaking";
        midNode.frequency.value = 900;
        midNode.Q.value = 0.9;
        midNode.gain.value = Number(mid.value);

        trebleNode = ctx.createBiquadFilter();
        trebleNode.type = "highshelf";
        trebleNode.frequency.value = 5000;
        trebleNode.gain.value = Number(treble.value);

        panNode = ctx.createStereoPanner();
        panNode.pan.value = Number(pan.value) / 100;

        compNode = ctx.createDynamicsCompressor();
        compNode.threshold.value = -18;
        compNode.knee.value = 18;
        compNode.ratio.value = 3;
        compNode.attack.value = 0.01;
        compNode.release.value = 0.18;

        gainNode = ctx.createGain();
        gainNode.gain.value = Number(vol.value) / 100;

        srcNode
          .connect(bassNode)
          .connect(midNode)
          .connect(trebleNode)
          .connect(panNode);

        panNode.connect(gainNode).connect(ctx.destination);
        audioUnlocked = true;
      }

      function applyControls() {
        if (!audioUnlocked) return;
        gainNode.gain.value = Number(vol.value) / 100;
        bassNode.gain.value = Number(bass.value);
        midNode.gain.value = Number(mid.value);
        trebleNode.gain.value = Number(treble.value);
        panNode.pan.value = Number(pan.value) / 100;
        audio.playbackRate = Number(rate.value);
      }

      function setToggle(btn, on) {
        btn.classList.toggle("on", !!on);
      }

      function clearLoops(silent = false) {
        audio.loop = false;
        abEnabled = false;
        A = null; B = null;

        setToggle(loopBtn, false);
        setToggle(abBtn, false);
        setToggle(aBtn, false);
        setToggle(bBtn, false);

        if (!silent) nowMeta.textContent = "Boucles désactivées.";
      }

      async function loadTrack(i, autoplay = false) {
        clearLoops(true);           // reset loops quand tu changes de piste
        const t = TRACKS[i];
        setNow();
        renderList();

        const url = MP3_FOLDER + t.file;
        audio.src = url;
        audio.load();

        await new Promise((resolve) => {
          const ok = () => { audio.removeEventListener("loadedmetadata", ok); resolve(); };
          audio.addEventListener("loadedmetadata", ok);
          audio.addEventListener("error", () => resolve(), { once: true });
        });

        tDur.textContent = fmt(audio.duration);
        if (autoplay) await play();
        else updateSeek();
      }

      async function fadeTo(target, seconds) {
        if (!audioUnlocked || seconds <= 0) {
          if (audioUnlocked) gainNode.gain.value = target;
          return;
        }
        const now = ctx.currentTime;
        const g = gainNode.gain;
        g.cancelScheduledValues(now);
        g.setValueAtTime(g.value, now);
        g.linearRampToValueAtTime(target, now + seconds);
      }

      function audioErrorHint(err) {
        const aerr = audio.error;
        if (aerr) return `Source audio invalide/non supportée : "${TRACKS[idx].file}" (dossier /mp3).`;
        if (err && (err.name || err.message)) return `Lecture refusée: ${err.name || "Erreur"}${err.message ? " — " + err.message : ""}`;
        return `Lecture impossible. Vérifie que le fichier existe dans /mp3.`;
      }

      async function play() {
        await unlockAudio();
        if (ctx.state === "suspended") await ctx.resume();

        applyControls();

        try {
          const baseVol = Number(vol.value) / 100;
          const fin = Number(fadeIn.value);
          if (fin > 0) {
            gainNode.gain.value = 0.0001;
            await audio.play();
            isPlaying = true;
            playBtn.textContent = "⏸ Pause";
            setBadge();
            await fadeTo(baseVol, fin);
          } else {
            await audio.play();
            isPlaying = true;
            playBtn.textContent = "⏸ Pause";
            setBadge();
          }
        } catch (e) {
          isPlaying = false;
          playBtn.textContent = "▶︎ Lecture";
          setBadge();
          nowMeta.textContent = audioErrorHint(e);
          console.error("play() failed:", e, "audio.error:", audio.error);
        }
      }

      function pause() {
        audio.pause();
        isPlaying = false;
        playBtn.textContent = "▶︎ Lecture";
        setBadge();
      }

      async function stop() {
        clearLoops(true);           // reset loops sur stop
        const fout = Number(fadeOut.value);
        if (audioUnlocked && fout > 0 && isPlaying) await fadeTo(0.0001, fout);

        audio.pause();
        audio.currentTime = 0;

        if (audioUnlocked) gainNode.gain.value = Number(vol.value) / 100;
        isPlaying = false;
        playBtn.textContent = "▶︎ Lecture";
        setBadge();
        updateSeek();
      }

      async function next() {
        idx = (idx + 1) % TRACKS.length;
        await loadTrack(idx, true);
      }

      async function prev() {
        idx = (idx - 1 + TRACKS.length) % TRACKS.length;
        await loadTrack(idx, true);
      }

      function updateSeek() {
        const dur = audio.duration || 0;
        const cur = audio.currentTime || 0;
        const pct = dur > 0 ? (cur / dur) * 100 : 0;
        seekFill.style.width = `${pct}%`;
        tCur.textContent = fmt(cur);
        if (Number.isFinite(dur) && dur > 0) tDur.textContent = fmt(dur);
      }

      // --- Events ---
      playBtn.addEventListener("click", async () => {
        if (isPlaying) pause();
        else await play();
      });
      stopBtn.addEventListener("click", stop);
      nextBtn.addEventListener("click", next);
      prevBtn.addEventListener("click", prev);

      loopBtn.addEventListener("click", () => {
        // si on active Loop "normal", on coupe A↔B pour éviter confusion
        if (!audio.loop) {
          abEnabled = false;
          setToggle(abBtn, false);
        }
        audio.loop = !audio.loop;
        setToggle(loopBtn, audio.loop);
      });

      aBtn.addEventListener("click", () => {
        audio.loop = false; setToggle(loopBtn, false); // A/B prend le contrôle
        A = audio.currentTime || 0;
        setToggle(aBtn, true);
        nowMeta.textContent = `Point A : ${fmt(A)}`;
      });

      bBtn.addEventListener("click", () => {
        audio.loop = false; setToggle(loopBtn, false);
        B = audio.currentTime || 0;
        setToggle(bBtn, true);
        nowMeta.textContent = `Point B : ${fmt(B)}`;
      });

      abBtn.addEventListener("click", () => {
        audio.loop = false; setToggle(loopBtn, false); // évite double loop
        abEnabled = !abEnabled;
        setToggle(abBtn, abEnabled);

        if (abEnabled) {
          if (A == null || B == null || !(B > A)) {
            abEnabled = false;
            setToggle(abBtn, false);
            nowMeta.textContent = "Pose A puis B (B doit être après A).";
            return;
          }
          nowMeta.textContent = "Loop A↔B activé.";
        } else {
          nowMeta.textContent = "Loop A↔B désactivé.";
        }
      });

      clearLoopBtn.addEventListener("click", () => clearLoops(false));

      compBtn.addEventListener("click", async () => {
        await unlockAudio();
        compressorOn = !compressorOn;
        setToggle(compBtn, compressorOn);

        try { panNode.disconnect(); } catch (_) {}
        try { compNode.disconnect(); } catch (_) {}

        if (compressorOn) panNode.connect(compNode).connect(gainNode);
        else panNode.connect(gainNode);
      });

      vol.addEventListener("input", () => { volVal.textContent = `${vol.value}%`; applyControls(); });
      bass.addEventListener("input", () => { const v = +bass.value; bassVal.textContent = `${v >= 0 ? "+" : ""}${v} dB`; applyControls(); });
      mid.addEventListener("input", () => { const v = +mid.value; midVal.textContent = `${v >= 0 ? "+" : ""}${v} dB`; applyControls(); });
      treble.addEventListener("input", () => { const v = +treble.value; trebleVal.textContent = `${v >= 0 ? "+" : ""}${v} dB`; applyControls(); });
      pan.addEventListener("input", () => { panVal.textContent = `${pan.value}`; applyControls(); });
      rate.addEventListener("input", () => { rateVal.textContent = `${Number(rate.value).toFixed(2)}×`; applyControls(); });
      fadeIn.addEventListener("input", () => { fadeInVal.textContent = `${Number(fadeIn.value).toFixed(1)}s`; });
      fadeOut.addEventListener("input", () => { fadeOutVal.textContent = `${Number(fadeOut.value).toFixed(1)}s`; });

      seekBar.addEventListener("click", (e) => {
        const rect = seekBar.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const pct = Math.min(1, Math.max(0, x / rect.width));
        if (audio.duration && Number.isFinite(audio.duration)) {
          audio.currentTime = pct * audio.duration;
          updateSeek();
        }
      });

      audio.addEventListener("timeupdate", () => {
        if (abEnabled && A != null && B != null && B > A) {
          if (audio.currentTime >= B) audio.currentTime = A + 0.001;
        }
        updateSeek();
      });

      audio.addEventListener("ended", async () => {
        if (!audio.loop && !abEnabled) await next();
      });

      audio.addEventListener("error", () => {
        nowMeta.textContent = audioErrorHint();
      });

      // init
      volVal.textContent = `${vol.value}%`;
      bassVal.textContent = `+${bass.value} dB`;
      midVal.textContent = `+${mid.value} dB`;
      trebleVal.textContent = `+${treble.value} dB`;
      panVal.textContent = `${pan.value}`;
      rateVal.textContent = `${Number(rate.value).toFixed(2)}×`;
      fadeInVal.textContent = `${Number(fadeIn.value).toFixed(1)}s`;
      fadeOutVal.textContent = `${Number(fadeOut.value).toFixed(1)}s`;

      setNow(); renderList(); setBadge();
      loadTrack(idx, false);
    })();
  </script>
</body>

</html>

